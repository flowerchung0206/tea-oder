import React, { useState, useEffect, useMemo } from 'react';
import { 
  Heart, 
  Check, 
  Plus, 
  Minus, 
  Search, 
  Star, 
  Zap, 
  ClipboardCopy, 
  ListTodo, 
  ArrowLeft, 
  Smartphone, 
  RotateCcw,
  History,
  Save,
  Trash2,
  Calendar,
  Truck,
  Coffee,
  MessageCircle
} from 'lucide-react';

const STORAGE_KEY = 'FISH_INVENTORY_V8_LUXE';
const HISTORY_KEY = 'FISH_INVENTORY_HISTORY_LUXE';

// åˆå§‹å“é …æ•¸æ“š
const INITIAL_DATA = [
  // èŒ¶è‘‰
  { id: 45, category: 'èŒ¶è‘‰ ğŸµ', name: 'å››å­£æ˜¥èŒ¶', threshold: 1, full: 5, unit: 'åŒ…', current: 0, notified: false },
  { id: 1, category: 'èŒ¶è‘‰ ğŸµ', name: 'é‡‘è±é’èŒ¶', threshold: 1, full: 5, unit: 'åŒ…', current: 0, notified: false },
  { id: 2, category: 'èŒ¶è‘‰ ğŸµ', name: 'é‡é‡‘è±', threshold: 0.5, full: 3, unit: 'åŒ…', current: 0, notified: false },
  { id: 3, category: 'èŒ¶è‘‰ ğŸµ', name: 'ç›§å“ˆå¨œç´…èŒ¶', threshold: 1, full: 5, unit: 'åŒ…', current: 0, notified: false },
  { id: 4, category: 'èŒ¶è‘‰ ğŸµ', name: 'è˜­é¦™ç¶ èŒ¶', threshold: 1, full: 5, unit: 'åŒ…', current: 0, notified: false },
  { id: 5, category: 'èŒ¶è‘‰ ğŸµ', name: 'æ±ºæ˜å­ç´…èŒ¶', threshold: 1, full: 5, unit: 'åŒ…', current: 0, notified: false },
  { id: 6, category: 'èŒ¶è‘‰ ğŸµ', name: 'æ³°å¼æ‰‹æ¨™ç´…èŒ¶', threshold: 2, full: 6, unit: 'åŒ…', current: 0, notified: false },
  // æœé†¬
  { id: 7, category: 'æœé†¬ ğŸ“', name: 'è”æé†¬', threshold: 0.5, full: 2, unit: 'ç½', info: 'å°‘æ–¼300cc', current: 0, notified: false },
  { id: 8, category: 'æœé†¬ ğŸ“', name: 'ç™¾é¦™é†¬', threshold: 0.5, full: 2, unit: 'ç½', info: 'å°‘æ–¼300cc', current: 0, notified: false },
  { id: 9, category: 'æœé†¬ ğŸ“', name: 'ç´…æŸšé†¬', threshold: 0.5, full: 2, unit: 'ç½', info: 'å°‘æ–¼300cc', current: 0, notified: false },
  { id: 10, category: 'æœé†¬ ğŸ“', name: 'èŠ’æœé†¬', threshold: 0.5, full: 2, unit: 'ç½', info: 'å°‘æ–¼300cc', current: 0, notified: false },
  { id: 11, category: 'æœé†¬ ğŸ“', name: 'èœ‚èœœé†¬', threshold: 0.5, full: 2, unit: 'ç½', info: 'å°‘æ–¼300cc', current: 0, notified: false },
  { id: 12, category: 'æœé†¬ ğŸ“', name: 'è—æŸ‘æ©˜', threshold: 0.1, full: 1, unit: 'ç“¶', info: 'å°‘æ–¼300cc', current: 0, notified: false },
  { id: 13, category: 'æœé†¬ ğŸ“', name: 'è”“è¶Šè“é†¬', threshold: 0.1, full: 1, unit: 'ç“¶', info: 'å°‘æ–¼300cc', current: 0, notified: false },
  { id: 14, category: 'æœé†¬ ğŸ“', name: 'è˜‹æœé†¬', threshold: 0.1, full: 1, unit: 'ç“¶', info: 'å°‘æ–¼300cc', current: 0, notified: false },
  { id: 15, category: 'æœé†¬ ğŸ“', name: 'è—è“é†¬', threshold: 0.1, full: 1, unit: 'ç“¶', info: 'å°‘æ–¼300cc', current: 0, notified: false },
  // å‡æœæ±
  { id: 16, category: 'å‡æœæ± â„ï¸', name: 'æª¸æª¬æ±', threshold: 0, full: 5, unit: 'åº«', info: 'ç„¡åº«å­˜', current: 0, notified: false },
  { id: 17, category: 'å‡æœæ± â„ï¸', name: 'èŠ’æœé†¬(å‡)', threshold: 0, full: 5, unit: 'åº«', info: 'ç„¡åº«å­˜', current: 0, notified: false },
  { id: 18, category: 'å‡æœæ± â„ï¸', name: 'ç”˜è”—æ±', threshold: 1, full: 5, unit: 'åº«', info: 'å‰©1', current: 0, notified: false },
  { id: 19, category: 'å‡æœæ± â„ï¸', name: 'ç™¾é¦™æœæ±', threshold: 0, full: 5, unit: 'åº«', info: 'ç„¡åº«å­˜', current: 0, notified: false },
  { id: 20, category: 'å‡æœæ± â„ï¸', name: 'æŸ³ä¸æ±', threshold: 0, full: 5, unit: 'åº«', info: 'ç„¡åº«å­˜', current: 0, notified: false },
  // å“ˆè’‚å» å•†
  { id: 21, category: 'å“ˆè’‚ ğŸšš', name: 'ç…‰ä¹³', threshold: 0, full: 12, unit: 'åº«', info: 'å†°ç®±ç©º', current: 0, notified: false },
  { id: 22, category: 'å“ˆè’‚ ğŸšš', name: 'å¥¶ç²¾', threshold: 1, full: 10, unit: 'åº«', info: 'å‰©1', current: 0, notified: false },
  { id: 23, category: 'å“ˆè’‚ ğŸšš', name: 'å†¬ç“œå¡Š', threshold: 1, full: 10, unit: 'åº«', info: 'å‰©1', current: 0, notified: false },
  { id: 24, category: 'å“ˆè’‚ ğŸšš', name: 'çç ', threshold: 0.33, full: 5, unit: 'åŒ…', info: 'å‰©1/3', current: 0, notified: false },
  { id: 25, category: 'å“ˆè’‚ ğŸšš', name: 'è”—ç³–', threshold: 0.33, full: 2, unit: 'æ¡¶', info: 'å‰©1/3', current: 0, notified: false },
  { id: 26, category: 'å“ˆè’‚ ğŸšš', name: 'ç²—å¸ç®¡', threshold: 2, full: 10, unit: 'åŒ…', current: 0, notified: false },
  { id: 27, category: 'å“ˆè’‚ ğŸšš', name: 'ç´°å¸ç®¡', threshold: 2, full: 10, unit: 'åŒ…', current: 0, notified: false },
  // ç²‰é¡
  { id: 28, category: 'ç²‰é¡ ğŸ§‚', name: 'å¥¶é…ªç²‰', threshold: 0.33, full: 3, unit: 'åŒ…', info: 'å‰©1/3', current: 0, notified: false },
  { id: 29, category: 'ç²‰é¡ ğŸ§‚', name: 'é»‘èŠéº»ç²‰', threshold: 0.1, full: 1, unit: 'åº«', info: 'å°‘æ–¼200g', current: 0, notified: false },
  { id: 30, category: 'ç²‰é¡ ğŸ§‚', name: 'æŠ¹èŒ¶ç²‰', threshold: 0.1, full: 1, unit: 'åº«', info: 'å°‘æ–¼200g', current: 0, notified: false },
  { id: 31, category: 'ç²‰é¡ ğŸ§‚', name: 'å¯å¯ç²‰', threshold: 0.1, unit: 'åº«', info: 'å°‘æ–¼200g', current: 0, notified: false },
  // è±†é¡
  { id: 32, category: 'è±†é¡ ğŸ«˜', name: 'ç¶ è±†', threshold: 1, full: 5, unit: 'åŒ…', info: 'å‰©1', current: 0, notified: false },
  // äº”ç©€é›œç³§
  { id: 33, category: 'äº”ç©€ ğŸŒ¾', name: 'äºŒç ‚', threshold: 0.1, full: 10, unit: 'åº«', info: 'å‰©åŠç½', current: 0, notified: false },
  { id: 34, category: 'äº”ç©€ ğŸŒ¾', name: 'ç´…ç³–æ¶²', threshold: 0.1, full: 5, unit: 'åº«', info: 'å‰©åŠåŒ…', current: 0, notified: false },
  // é…·æœ‹è¨‚è²¨
  { id: 35, category: 'é…·æœ‹ ğŸ“¦', name: 'å¥¶æ°´', threshold: 0, full: 12, unit: 'åº«', current: 0, notified: false },
  { id: 36, category: 'é…·æœ‹ ğŸ“¦', name: 'è¡›ç”Ÿç´™', threshold: 1, full: 12, unit: 'åŒ…', current: 0, notified: false },
  { id: 37, category: 'é…·æœ‹ ğŸ“¦', name: 'æ²æµ´ä¹³', threshold: 0, full: 3, unit: 'åº«', current: 0, notified: false },
  { id: 38, category: 'é…·æœ‹ ğŸ“¦', name: 'æ´—ç¢—ç²¾', threshold: 0, full: 5, unit: 'åº«', current: 0, notified: false },
  { id: 39, category: 'é…·æœ‹ ğŸ“¦', name: 'ä¿é®®è†œ', threshold: 0, full: 3, unit: 'åº«', current: 0, notified: false },
  // å®¹å™¨
  { id: 40, category: 'å®¹å™¨ ğŸ¥¤', name: 'å¥¶é…ªæ¯', threshold: 1, full: 10, unit: 'æ¢', current: 0, notified: false },
  { id: 41, category: 'å®¹å™¨ ğŸ¥¤', name: 'å°é¬†é¤…ç›’', threshold: 20, full: 100, unit: 'å€‹', current: 0, notified: false },
  { id: 42, category: 'å®¹å™¨ ğŸ¥¤', name: 'å¤§é¬†é¤…ç›’', threshold: 20, full: 100, unit: 'å€‹', current: 0, notified: false },
  { id: 43, category: 'å®¹å™¨ ğŸ¥¤', name: 'å‰å­', threshold: 20, full: 200, unit: 'æ”¯', current: 0, notified: false },
  { id: 44, category: 'å®¹å™¨ ğŸ¥¤', name: 'æ¹¯åŒ™', threshold: 10, full: 200, unit: 'æ”¯', current: 0, notified: false },
];

export default function App() {
  const [items, setItems] = useState(() => {
    const saved = localStorage.getItem(STORAGE_KEY);
    if (saved) {
      try {
        const parsed = JSON.parse(saved);
        const existingIds = new Set(parsed.map(i => i.id));
        const missingItems = INITIAL_DATA.filter(i => !existingIds.has(i.id));
        const syncedItems = parsed.map(item => {
          const original = INITIAL_DATA.find(i => i.id === item.id);
          return original ? { ...item, full: original.full } : item;
        });
        return [...syncedItems, ...missingItems];
      } catch (e) { return INITIAL_DATA; }
    }
    return INITIAL_DATA;
  });

  const [history, setHistory] = useState(() => {
    const saved = localStorage.getItem(HISTORY_KEY);
    return saved ? JSON.parse(saved) : [];
  });

  const [searchTerm, setSearchTerm] = useState('');
  const [view, setView] = useState('all'); 
  const [showCopyMsg, setShowCopyMsg] = useState(false);
  const [saveFlash, setSaveFlash] = useState(false);

  const autoSave = (newItems) => {
    setItems(newItems);
    localStorage.setItem(STORAGE_KEY, JSON.stringify(newItems));
    setSaveFlash(true);
    setTimeout(() => setSaveFlash(false), 500);
  };

  const saveToHistory = () => {
    const timestamp = new Date().toLocaleString('zh-TW', { hour12: false });
    const lowStocks = items.filter(i => i.current <= i.threshold);
    const newEntry = {
      id: Date.now(),
      time: timestamp,
      data: items,
      lowCount: lowStocks.length
    };
    const newHistory = [newEntry, ...history].slice(0, 20);
    setHistory(newHistory);
    localStorage.setItem(HISTORY_KEY, JSON.stringify(newHistory));
    alert(`ä»Šæ—¥æ•¸æ“šå·²å°å­˜ ğŸ¤`);
  };

  const deleteHistory = (id) => {
    if(confirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†ç´€éŒ„å—ï¼Ÿ')) {
        const newHistory = history.filter(h => h.id !== id);
        setHistory(newHistory);
        localStorage.setItem(HISTORY_KEY, JSON.stringify(newHistory));
    }
  };

  const updateQuantity = (id, delta) => {
    const newItems = items.map(item => {
      if (item.id === id) {
        const newVal = Math.max(0, parseFloat((item.current + delta).toFixed(2)));
        return { ...item, current: newVal };
      }
      return item;
    });
    autoSave(newItems);
  };

  const replenishItem = (id) => {
    const newItems = items.map(item => {
      if (item.id === id) {
        return { ...item, current: item.full, notified: false };
      }
      return item;
    });
    autoSave(newItems);
  };

  const handleInputChange = (id, value) => {
    const numValue = value === '' ? 0 : parseFloat(value);
    const newItems = items.map(item => 
      item.id === id ? { ...item, current: isNaN(numValue) ? 0 : numValue } : item
    );
    autoSave(newItems);
  };

  const toggleNotified = (id) => {
    const newItems = items.map(item => 
      item.id === id ? { ...item, notified: !item.notified } : item
    );
    autoSave(newItems);
  };

  const lowStockItems = useMemo(() => items.filter(i => i.current <= i.threshold), [items]);

  const groupedItems = useMemo(() => {
    const filtered = items.filter(item => 
      item.name.includes(searchTerm) || item.category.includes(searchTerm)
    );
    return filtered.reduce((acc, item) => {
      if (!acc[item.category]) acc[item.category] = [];
      acc[item.category].push(item);
      return acc;
    }, {});
  }, [items, searchTerm]);

  const getMessageText = () => {
    const timestamp = new Date().toLocaleString('zh-TW', { hour12: false });
    const header = `åª½åª½/çˆ¸çˆ¸ï¼Œé€™æ˜¯ä»Šæ—¥(${timestamp})çš„è£œè²¨æ¸…å–®ï¼š\n--------------------\n`;
    const body = lowStockItems.length > 0 
      ? lowStockItems.map(i => `ğŸ“ ${i.name}: å‰© ${i.current} ${i.unit} ${i.info ? `[${i.info}]` : ''}`).join('\n')
      : 'ç›®å‰åº«å­˜éƒ½å¾ˆè¶³å¤ å–”ï¼âœ¨';
    const footer = `\n--------------------\nå¦‚æœæœ‰è£œå……å‘Šè¨´æˆ‘ï¼â¤ï¸`;
    return header + body + footer;
  };

  const copyToClipboard = () => {
    const textToCopy = getMessageText();
    const textArea = document.createElement("textarea");
    textArea.value = textToCopy;
    document.body.appendChild(textArea);
    textArea.select();
    document.execCommand('copy');
    document.body.removeChild(textArea);
    setShowCopyMsg(true);
    setTimeout(() => setShowCopyMsg(false), 2000);
  };

  const sendToLine = () => {
    const textToCopy = getMessageText();
    // ä½¿ç”¨ LINE URL Scheme å‚³é€æ–‡å­—
    const lineUrl = `https://line.me/R/msg/text/?${encodeURIComponent(textToCopy)}`;
    window.open(lineUrl, '_blank');
  };

  return (
    <div className="min-h-screen bg-[#F8F4F1] p-3 md:p-6 font-sans text-[#4A3728]">
      <div className="max-w-2xl mx-auto pb-40">
        
        {/* Header */}
        <header className="bg-white rounded-[40px] shadow-xl shadow-stone-200 p-6 mb-6 border-4 border-[#DBC4B0]">
          <div className="flex items-center justify-between mb-4">
            <div className="flex items-center gap-3">
              <div className="bg-[#8B5E3C] p-3 rounded-2xl rotate-3 shadow-md active:scale-110 transition-transform">
                <Coffee className="text-white" size={32} />
              </div>
              <div>
                <h1 className="text-2xl font-black text-[#5D4037] tracking-tighter">åº«å­˜é»é»å</h1>
                <div className="flex items-center gap-1">
                  <span className={`text-[12px] font-black flex items-center gap-0.5 transition-all ${saveFlash ? 'text-amber-600 scale-110' : 'text-stone-400'}`}>
                    <Smartphone size={12}/> {saveFlash ? 'å¿«é¦¬åŠ é­å„²å­˜ä¸­...' : 'æ•¸æ“šå·²å®‰å…¨å°å­˜'}
                  </span>
                </div>
              </div>
            </div>
            
            <div className="flex bg-stone-100 p-1.5 rounded-2xl border border-stone-200 shadow-inner overflow-x-auto no-scrollbar">
              <button onClick={() => setView('all')} className={`px-4 py-2.5 rounded-xl text-sm font-black transition-all whitespace-nowrap ${view === 'all' ? 'bg-[#A68A64] text-white shadow-md' : 'text-stone-400'}`}>æ¸…é»</button>
              <button onClick={() => setView('report')} className={`px-4 py-2.5 rounded-xl text-sm font-black transition-all whitespace-nowrap ${view === 'report' ? 'bg-[#A68A64] text-white shadow-md' : 'text-stone-400'}`}>å‘ŠçŸ¥</button>
              <button onClick={() => setView('history')} className={`px-4 py-2.5 rounded-xl text-sm font-black transition-all whitespace-nowrap ${view === 'history' ? 'bg-[#A68A64] text-white shadow-md' : 'text-stone-400'}`}>æ­·å²</button>
            </div>
          </div>

          {view === 'all' && (
            <div className="relative">
              <Search className="absolute left-5 top-1/2 -translate-y-1/2 text-stone-300" size={20} />
              <input 
                type="text" 
                placeholder="æœå°‹æ¸…å–®å“é …..." 
                value={searchTerm} 
                onChange={(e) => setSearchTerm(e.target.value)}
                className="w-full pl-12 pr-4 py-4 bg-[#FAF7F2] border-2 border-stone-100 focus:border-[#DBC4B0] rounded-full outline-none font-bold text-base"
              />
            </div>
          )}
        </header>

        {/* View Switch */}
        {view === 'all' && (
          <div className="space-y-5">
            {Object.keys(groupedItems).map(category => (
              <div key={category} className="bg-white rounded-[32px] border-2 border-[#E9E0D2] overflow-hidden shadow-sm">
                <div className="bg-[#FCF9F7] px-6 py-3 border-b-2 border-[#E9E0D2]">
                  <h2 className="font-black text-[#8B5E3C] text-[14px] uppercase tracking-widest flex items-center gap-2">
                    <Star size={14} fill="#8B5E3C" /> {category}
                  </h2>
                </div>
                <div className="divide-y-2 divide-[#F3EDE6]">
                  {groupedItems[category].map((item) => {
                    const isLow = item.current <= item.threshold;
                    return (
                      <div key={item.id} className={`flex items-center px-4 py-4 transition-all ${item.notified ? 'bg-stone-50 opacity-40' : (isLow ? 'bg-[#FFF2F2]' : 'hover:bg-stone-50')}`}>
                        <div className="flex-shrink-0 w-10 flex justify-center">
                          {isLow ? <Heart size={20} fill="#E7C6C6" className="text-[#E7C6C6] animate-pulse" /> : <div className="w-2.5 h-2.5 rounded-full bg-stone-200"></div>}
                        </div>
                        <div className="flex-grow flex flex-col overflow-hidden mr-2">
                          <span className="font-black text-[#5D4037] whitespace-nowrap overflow-hidden text-ellipsis text-lg leading-tight">{item.name}</span>
                          {item.info && <span className="text-[11px] font-black text-stone-400 whitespace-nowrap mt-0.5">{item.info}</span>}
                        </div>
                        
                        <div className="flex-shrink-0 flex items-center gap-1.5 bg-white p-1 rounded-full border border-stone-200 mr-2 shadow-sm">
                          <button 
                            onClick={() => replenishItem(item.id)} 
                            className="w-10 h-10 rounded-full bg-[#8E735B] flex items-center justify-center text-white active:scale-75 transition-all shadow-sm mr-1"
                            title="å¿«é€Ÿè£œæ»¿"
                          >
                            <Truck size={18} />
                          </button>
                          
                          <button onClick={() => updateQuantity(item.id, -0.5)} className="w-9 h-9 rounded-full bg-stone-100 flex items-center justify-center text-stone-500 active:scale-75 transition-all"><Minus size={16} strokeWidth={4} /></button>
                          <input type="number" step="0.1" value={item.current} onChange={(e) => handleInputChange(item.id, e.target.value)} className={`w-12 text-center bg-transparent font-black text-xl outline-none ${isLow ? 'text-red-800' : 'text-[#8B5E3C]'}`} />
                          <button onClick={() => updateQuantity(item.id, 0.5)} className="w-9 h-9 rounded-full bg-stone-100 flex items-center justify-center text-stone-500 active:scale-75 transition-all"><Plus size={16} strokeWidth={4} /></button>
                        </div>
                        
                        <button onClick={() => toggleNotified(item.id)} className={`flex-shrink-0 w-10 h-10 rounded-2xl flex items-center justify-center transition-all ${item.notified ? 'bg-[#D4A373] text-white rotate-6 scale-110 shadow-md' : 'bg-white border-2 border-stone-100 text-stone-200'}`}><Check size={22} strokeWidth={4} /></button>
                      </div>
                    );
                  })}
                </div>
              </div>
            ))}
            
            <div className="flex gap-2 mt-8">
                <button 
                  onClick={saveToHistory}
                  className="flex-1 py-5 bg-[#A67C52] text-white rounded-[24px] font-black flex items-center justify-center gap-2 shadow-lg shadow-stone-200 active:scale-95 transition-all text-lg"
                >
                  <Save size={24} /> æ•¸æ“šå°å­˜
                </button>
                <button 
                  onClick={() => { if(confirm('è¦é‡ç½®æ•¸å­—å—ï¼Ÿ')) autoSave(INITIAL_DATA); }}
                  className="w-20 py-5 bg-white text-stone-300 rounded-[24px] border-2 border-stone-100 flex items-center justify-center active:scale-95 transition-all"
                >
                  <RotateCcw size={24} />
                </button>
            </div>
          </div>
        )}

        {view === 'report' && (
          <div className="animate-in fade-in slide-in-from-bottom-4 duration-500">
            <div className="bg-white rounded-[40px] p-8 border-4 border-dashed border-[#DBC4B0] text-center relative overflow-hidden shadow-xl">
              <div className="absolute -top-6 -right-6 w-24 h-24 bg-[#F8F4F1] rounded-full opacity-50"></div>
              <div className="w-20 h-20 bg-[#F3EDE6] rounded-full flex items-center justify-center mx-auto mb-4 scale-110"><Coffee className="text-[#8B5E3C]" size={40} /></div>
              <h2 className="text-2xl font-black text-[#5D4037] mb-6 tracking-tight">è£œè²¨å›å ± ğŸ¤</h2>
              <div className="text-left bg-[#FCF9F7] rounded-[32px] p-6 mb-6 font-mono text-base border-2 border-stone-100 leading-loose max-h-[400px] overflow-y-auto shadow-inner text-[#5D4037]">
                <div className="whitespace-pre-wrap font-bold">{getMessageText()}</div>
              </div>
              
              <div className="flex flex-col gap-3">
                <button 
                  onClick={sendToLine} 
                  className="group flex items-center justify-center gap-3 w-full py-6 rounded-[28px] font-black bg-[#06C755] text-white shadow-lg active:scale-95 transition-all text-xl shadow-green-100"
                >
                  <MessageCircle size={28} /> ä¸€éµç™¼é€ LINE å‘ŠçŸ¥
                </button>
                <button 
                  onClick={copyToClipboard} 
                  className="group flex items-center justify-center gap-3 w-full py-5 rounded-[24px] font-black border-2 border-[#8B5E3C] text-[#8B5E3C] active:scale-95 transition-all text-lg"
                >
                  <ClipboardCopy size={24} /> åƒ…è¤‡è£½è¨Šæ¯å…§å®¹
                </button>
              </div>

              <button onClick={() => setView('all')} className="mt-8 text-stone-400 font-black text-base flex items-center justify-center gap-2 mx-auto transition-colors hover:text-stone-600"><ArrowLeft size={20} /> è¿”å›æ¸…é»</button>
            </div>
          </div>
        )}

        {view === 'history' && (
          <div className="animate-in fade-in slide-in-from-bottom-4 duration-500 space-y-4">
            <div className="bg-[#8B5E3C] rounded-[32px] p-6 text-white shadow-lg">
                <div className="flex items-center gap-3">
                    <History size={28} />
                    <h2 className="text-2xl font-black">æ­·å²æ•¸æ“šå­˜æª”</h2>
                </div>
            </div>

            {history.length > 0 ? history.map((h) => (
                <div key={h.id} className="bg-white rounded-[28px] p-6 border-2 border-[#E9E0D2] shadow-sm flex items-center justify-between">
                    <div className="flex items-center gap-4">
                        <div className="bg-stone-50 p-3 rounded-2xl">
                            <Calendar className="text-[#8B5E3C]" size={24} />
                        </div>
                        <div>
                            <div className="text-base font-black text-[#5D4037]">{h.time}</div>
                            <div className="text-xs font-bold text-stone-400">ç•¶å‰æœ‰ {h.lowCount} é …è­¦ç¤ºå“é …</div>
                        </div>
                    </div>
                    <div className="flex gap-2">
                        <button 
                            onClick={() => {
                                if(confirm(`è¦é‚„åŸæ­¤ç´€éŒ„å—ï¼Ÿ`)) {
                                    setItems(h.data);
                                    localStorage.setItem(STORAGE_KEY, JSON.stringify(h.data));
                                    setView('all');
                                }
                            }}
                            className="bg-stone-100 text-[#8B5E3C] p-3.5 rounded-2xl active:scale-75 transition-all"
                        >
                            <Zap size={22} fill="currentColor" />
                        </button>
                        <button 
                            onClick={() => deleteHistory(h.id)}
                            className="bg-stone-50 text-stone-300 p-3.5 rounded-2xl active:scale-75 transition-all"
                        >
                            <Trash2 size={22} />
                        </button>
                    </div>
                </div>
            )) : (
                <div className="text-center py-24 bg-white rounded-[40px] border-4 border-dashed border-stone-100 text-stone-300 font-black italic">
                    å°šæœªæœ‰å°å­˜çš„ç´€éŒ„
                </div>
            )}
            <button onClick={() => setView('all')} className="flex items-center justify-center gap-2 text-stone-400 font-black py-6 w-full text-lg transition-colors hover:text-stone-600"><ArrowLeft size={20} /> è¿”å›æ¸…é»</button>
          </div>
        )}

        {/* è¤‡è£½æˆåŠŸæç¤º */}
        {showCopyMsg && (
          <div className="fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-[#5D4037]/95 text-white px-10 py-5 rounded-full font-black flex items-center gap-3 animate-bounce shadow-2xl z-50 text-lg">
            <Zap fill="#D4A373" className="text-[#D4A373]" /> è¤‡è£½æˆåŠŸ
          </div>
        )}

        {/* åº•éƒ¨å°è¦½æ¬„ */}
        {view === 'all' && (
          <div className="fixed bottom-8 left-1/2 -translate-x-1/2 w-[calc(100%-3rem)] max-w-2xl z-40">
            <div className="flex items-center justify-between p-5 bg-[#5D4037] rounded-[36px] text-white shadow-2xl border-b-4 border-[#3E2723]">
              <div className="flex gap-6 ml-4">
                <div className="flex flex-col"><span className="text-[10px] font-black opacity-80 uppercase tracking-widest">è­¦å‘Š</span><span className="text-2xl font-black text-[#E7C6C6]">{lowStockItems.length}</span></div>
                <div className="w-px h-8 bg-white/20 self-center"></div>
                <div className="flex flex-col"><span className="text-[10px] font-black opacity-80 uppercase tracking-widest">å‘ŠçŸ¥</span><span className="text-2xl font-black">{items.filter(i => i.notified).length}</span></div>
              </div>
              <button className="bg-[#A68A64] text-white px-8 py-4 rounded-[24px] font-black text-base flex items-center gap-2 active:scale-90 transition-all shadow-md" onClick={() => setView('report')}><ListTodo size={20} /> å‘ŠçŸ¥æ¸…å–®</button>
            </div>
          </div>
        )}
      </div>

      <style dangerouslySetInnerHTML={{ __html: `
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@500;700;900&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #F8F4F1; margin: 0; padding: 0; overflow-x: hidden; -webkit-tap-highlight-color: transparent; }
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .animate-in { animation: fadeIn 0.4s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
      ` }} />
    </div>
  );
}
